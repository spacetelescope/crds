name: CI

on:
  push:
    branches:
      - master
    tags:
      - '*'
  pull_request:

env:
  CRDS_SERVER_URL: https://hst-crds.stsci.edu
  CRDS_TEST_ROOT: /tmp
  LD_LIBRARY_PATH: /usr/local/lib

jobs:
  test:
    name: ${{ matrix.runs-on }} Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        runs-on:
          - ubuntu-latest
          - macos-latest
        python-version:
          - 3.8
          - 3.9
    steps:
      - uses: actions/checkout@v3
      - uses: mamba-org/provision-with-micromamba@v14
        with:
          environment-file: environment.yml
          extra-specs: |
            python=${{ matrix.python-version }}
          cache-env: true
          cache-downloads: true
      - run: |
          pip install roman-datamodels git+https://github.com/spacetelescope/jwst
          pip uninstall --yes crds
          ./install
          pip install ".[submission,test,docs,synphot]"
          ./setup_test_cache $CRDS_TEST_ROOT
      - run: pytest --cov=crds
