name: CI

on:
  push:
    branches:
      - master
    tags:
      - '*'
  pull_request:

env:
  CRDS_SERVER_URL: https://hst-crds.stsci.edu
  CRDS_TEST_ROOT: /tmp
  LD_LIBRARY_PATH: /usr/local/lib

defaults:
  run:
    shell: bash -l {0}

jobs:
  test:
    name: run tests (Python ${{ matrix.python }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest ]
        python: [ '3.8', '3.9', '3.10', '3.11' ]
    steps:
      - uses: actions/checkout@v3
      - uses: mamba-org/provision-with-micromamba@v14
        with:
          environment-file: environment.yml
          extra-specs: |
            python=${{ matrix.python }}
          cache-env: true
          cache-downloads: true
      - run: |
          pip install roman-datamodels git+https://github.com/spacetelescope/jwst
          pip uninstall --yes crds
          ./install
          pip install ".[submission,test,docs,synphot]"
          ./setup_test_cache $CRDS_TEST_ROOT
      - run: pytest --cov=crds
