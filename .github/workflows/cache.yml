name: test cache

on:
  workflow_call:
    outputs:
      path:
        value: ${{ jobs.cache.outputs.path }}
      key:
        value: ${{ jobs.cache.outputs.key }}
  workflow_dispatch:
  schedule:
    # Weekly Monday 9AM
    - cron: "0 9 * * 1"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CRDS_PATH: /tmp/crds-cache-default-test
  CRDS_TEST_ROOT: /tmp
  CRDS_CLIENT_RETRY_COUNT: 3
  CRDS_CLIENT_RETRY_DELAY_SECONDS: 20
  LD_LIBRARY_PATH: /usr/local/lib

defaults:
  run:
    shell: bash -leo pipefail {0} {0}

jobs:
  contexts:
    uses: ./.github/workflows/contexts.yml
  cache:
    needs: [ contexts ]
    name: download and cache CRDS test files
    runs-on: ubuntu-latest
    outputs:
      path: ${{ env.CRDS_PATH }}
      key: ${{ steps.key.outputs.key }}
    steps:
      - uses: actions/checkout@v3
      - uses: mamba-org/setup-micromamba@v1
        with:
          environment-name: crds-testing
          create-args: >-
            python=3
            asdf
            astropy
            filelock
            numpy
            parsley
            requests
          init-shell: bash
          cache-environment: true
          cache-downloads: true
      - run: pip install roman-datamodels stdatamodels
      - run: ./install && pip install .
      - name: restore cached HST files
        uses: actions/cache@v3
        with:
          path: ${{ env.CRDS_PATH }}/**/hst*
          key: test-cache-${{ needs.contexts.outputs.hst }}
      - name: restore cached JWST files
        uses: actions/cache@v3
        with:
          path: ${{ env.CRDS_PATH }}/**/jwst*
          key: test-cache-${{ needs.contexts.outputs.jwst }}
      - id: key
        run: echo "key=test-cache-${{ needs.contexts.outputs.hst }}-${{ needs.contexts.outputs.jwst }}" >> $GITHUB_OUTPUT
      - name: combine caches
        uses: actions/cache@v3
        with:
          path: ${{ env.CRDS_PATH }}
          key: ${{ steps.key.outputs.key }}
      - run: ./setup_test_cache ${{ env.CRDS_TEST_ROOT }}
